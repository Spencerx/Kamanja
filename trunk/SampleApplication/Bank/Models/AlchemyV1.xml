

<!--
	Barclay Bank Alchemy Ruleset.  See AlchemyDailyFeePricingAlerts-DIHighLevelDesign.v1.1
	document for textual explanation of the ruleset.  Relevant sections:

		Emergency Borrowing Alert Business Logic
		Near Overdraft Alert
		Overdraft Tier 3 Alert
		Overdraft Tier 2 Alert
		Overdraft Tier 1 Alert
		Low Balance Alerts Business Logic
-->

<PMML xmlns="http://www.dmg.org/PMML-4_1" version="4.1">

	<Header copyright="Barclay Bank (2014)" description="Rules that consider bank machine transactions used to determine whether the Alchemy overdraft alerts should be issued for Barclay Bank customers ">
		<Application name="AlchemyAlerts" version="00.01.00"/>
	</Header>

	<DataDictionary numberOfFields="4">
		<DataField name="msg" displayName="msg" optype="categorical" dataType="BankPocMsg"/>
		<DataField name="gCtx" displayName="globalContext" optype="categorical" dataType="EnvContext"/>
	    <DataField name="parameters" displayName="parameters" dataType="container">
	       <Value value="gCtx" property="valid"/>
	       <Value value="msg" property="valid"/>
	    </DataField>
		<DataField name="AlertType" displayName="AlertType" optype="categorical" dataType="string"/>
		<DataField name="SendResult" displayName="SendResult" optype="categorical" dataType="string"/>
		<DataField name="OfflineEvent" displayName="OfflineEvent" optype="categorical" dataType="string"/>


		<DataField name="RUN_LDG_XAU" displayName="RUN_LDG_XAU" optype="continuous" dataType="double"/>
		<DataField name="ACCT_SHORT_NM" displayName="ACCT_SHORT_NM" optype="categorical" dataType="string"/>
		<DataField name="ENT_DTE" displayName="ENT_DTE" optype="continuous" dataType="integer"/>
		<DataField name="MOBILE_NUMBER" displayName="MOBILE_NUMBER" optype="categorical" dataType="string"/>

	</DataDictionary>

	<TransformationDictionary>

		<!--
			**********************************************************
			*  EnvContext Access 
			**********************************************************
		-->

		<!--
			Obtain the Alert History for this client
		-->
		<DerivedField name="ClientAlertsToday" dataType="AlertHistory" optype="categorical">
			<Apply function="Get">
				<FieldRef field="gCtx"/>
			    <Constant dataType="string">System.AlertHistory</Constant>
			    <FieldRef field="msg.ent_acc_num"/>
			</Apply>
		</DerivedField>

		<!--
			Obtains this client's preferences
		-->
		<DerivedField name="ClientPrefs" dataType="CustomerPreferences" optype="categorical">
			<Apply function="Get">
				<FieldRef field="gCtx"/>
			    <Constant dataType="string">System.CustomerPreferences</Constant>
			    <FieldRef field="msg.ent_acc_num"/>
			</Apply>
		</DerivedField>

		<!--
			Obtain this client's tier limits 
		-->
		<DerivedField name="ClientTierLimits" dataType="TukTier" optype="categorical">
			<Apply function="Get">
				<FieldRef field="gCtx"/>
			    <Constant dataType="string">System.TukTier</Constant>
			    <FieldRef field="ClientPrefs.risk_tier_id"/>
			</Apply>
		</DerivedField>

		<!--
			EB Alert parms  
		-->
		<DerivedField name="EBAlertParms" dataType="AlertParameters" optype="categorical">
			<Apply function="Get">
				<FieldRef field="gCtx"/>
			    <Constant dataType="string">System.AlertParameters</Constant>
			    <Constant dataType="string">EB</Constant>
			</Apply>
		</DerivedField>

		<!--
			NO Alert parms   
		-->
		<DerivedField name="NOAlertParms" dataType="AlertParameters" optype="categorical">
			<Apply function="Get">
				<FieldRef field="gCtx"/>
			    <Constant dataType="string">System.AlertParameters</Constant>
			    <Constant dataType="string">NO</Constant>
			</Apply>
		</DerivedField>

		<!--
			OD Alert Alert parms 
		-->
		<DerivedField name="ODAlertParms" dataType="AlertParameters" optype="categorical">
			<Apply function="Get">
				<FieldRef field="gCtx"/>
			    <Constant dataType="string">System.AlertParameters</Constant>
			    <Constant dataType="string">OD</Constant>
			</Apply>
		</DerivedField>

		<!--
			LB Alert parms 
		-->
		<DerivedField name="LBAlertParms" dataType="AlertParameters" optype="categorical">
			<Apply function="Get">
				<FieldRef field="gCtx"/>
			    <Constant dataType="string">System.AlertParameters</Constant>
			    <Constant dataType="string">LB</Constant>
			</Apply>
		</DerivedField>


		<!--
			**********************************************************
			*  Generally used derivations 
			**********************************************************
		-->

		<!--
			Calculate the prior balance (excl)
		-->
		<DerivedField name="PreviousBalance" dataType="double" optype="continuous">
			<Apply function="-">
				<FieldRef field="msg.run_ldg_xau"/>
				<FieldRef field="msg.ent_amt"/>
			</Apply>
		</DerivedField>


		<!-- 
			Materialize these variables from their containers to derived fields to make
			them accessible for output emission 
		-->

		<DerivedField name="MaterializeOutputs" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="Put">  
					<Constant dataType="string">RUN_LDG_XAU</Constant>
					<FieldRef field="msg.run_ldg_xau"/>
				</Apply>
				<Apply function="Put">  
					<Constant dataType="string">ACCT_SHORT_NM</Constant>
					<FieldRef field="ClientPrefs.acct_short_nm"/>
				</Apply>
				<Apply function="Put">  
					<Constant dataType="string">ENT_DTE</Constant>
					<FieldRef field="msg.ent_dte"/>
				</Apply>
				<Apply function="Put">  
					<Constant dataType="string">MOBILE_NUMBER</Constant>
					<FieldRef field="ClientPrefs.mobile_number"/>
				</Apply>
			</Apply>
		</DerivedField>

		<!-- 
			Persist the new AlertHistory state for the current account 
		-->
		<DerivedField name="AlertHistoryUpdate" dataType="boolean" optype="categorical">
			<Apply function="Put">
			    <FieldRef field="gCtx"/>
			    <Constant dataType="string">AlertHistory</Constant>
			    <FieldRef field="msg.ent_acc_num"/>
				<FieldRef field="ClientAlertsToday"/>
			</Apply>
		</DerivedField>


		<!--
			Compute the number of alerts seen today
		-->
		<DerivedField name="SumOfAlertsSeenToday" dataType="integer" optype="continuous">
			<Apply function="+">
				<FieldRef field="ClientAlertsToday.lb001sent"/>
				<FieldRef field="ClientAlertsToday.od001sent"/>
				<FieldRef field="ClientAlertsToday.od002sent"/>
				<FieldRef field="ClientAlertsToday.od003sent"/>
				<FieldRef field="ClientAlertsToday.no001sent"/>
				<FieldRef field="ClientAlertsToday.eb001sent"/>
				<FieldRef field="ClientAlertsToday.eb002sent"/>
			</Apply>
		</DerivedField>

		<!--
			**********************************************************
			*  EB Alert Derivation 
			**********************************************************
		-->

		<!--
			Note if the event being considered occurred after hours
		-->
		<DerivedField name="EBOfflineEvent" dataType="boolean" optype="categorical">
			<Apply function="not">
				<Apply function="Between">
					<Apply function="CompressedTimeHHMMSSCC2Secs">
						<FieldRef field="msg.ent_tme"/>
					</Apply>
					<FieldRef field="EBAlertParms.online_start_time"/>
					<FieldRef field="EBAlertParms.online_end_time"/>
					<Constant dataType="boolean">true</Constant>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Classify the emergency borrowing severity (NOTE: This derived field
			always evaluates "true"... the difference is in the side effect
			update of AlertType)
		-->
		<DerivedField name="EBAlertType" dataType="boolean" optype="categorical">
			<Apply function="if">
				<Apply function="greaterOrEqual">
					<FieldRef field="ClientPrefs.max_eb_cnt"/>
					<FieldRef field="ClientTierLimits.t6_max_per_period_cnt"/>
				</Apply>
				<Apply function="Put">  <!-- Set AlertType -->
					<Constant dataType="string">AlertType</Constant>
					<Constant dataType="string">EB2</Constant> 
				</Apply>
				<Apply function="Put">  <!-- Set AlertType -->
					<Constant dataType="string">AlertType</Constant>
					<Constant dataType="string">EB1</Constant> 
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Assess whether an online EB event notification is to be issued
		-->
		<DerivedField name="ShouldOnlineEBEventBeIssued" dataType="boolean" optype="categorical">
			<Apply function="not">
				<Apply function="or">
					<Apply function="greaterOrEqual">
						<Apply function="+">
							<FieldRef field="ClientAlertsToday.eb001sent"/>
							<FieldRef field="ClientAlertsToday.eb002sent"/>
						</Apply>
						<FieldRef field="EBAlertParms.max_alerts_per_day"/>
					</Apply>
					<Apply function="greaterThan">
						<Apply function="+">
							<FieldRef field="ClientAlertsToday.utfsent"/>
							<FieldRef field="ClientAlertsToday.ptfsent"/>
						</Apply>
						<Constant dataType="integer">0</Constant>
					</Apply>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Does this client subscribe to the emergency borrowing account feature
		-->
		<DerivedField name="AcctHasEBLimit" dataType="boolean" optype="categorical">
			<Apply function="lessThan">
				<FieldRef field="msg.ant_lmt"/>
				<Constant dataType="double">0</Constant>
			</Apply>
		</DerivedField>

		<!--
			Is the auth run ledger balance in the emergency borrowing range?
		-->
		<DerivedField name="InEmergencyBorrowRange" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="greaterOrEqual">
					<FieldRef field="msg.run_ldg_xau"/>
					<Apply function="+">
						<FieldRef field="msg.odr_lmt"/>
						<FieldRef field="msg.ant_lmt"/>
						<FieldRef field="msg.unp_buff"/>
					</Apply>
				</Apply>
				<Apply function="lessThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<Apply function="+">
						<FieldRef field="msg.odr_lmt"/>
						<FieldRef field="msg.eb_buffer"/>
					</Apply>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Answer whether the debit in current message caused an emergency borrowing condition
		-->
		<DerivedField name="DebitHasCausedEBCondition" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="greaterOrEqual">
					<FieldRef field="PreviousBalance"/>
					<Apply function="+">
						<FieldRef field="msg.odr_lmt"/>
						<FieldRef field="msg.eb_buffer"/>
					</Apply>
				</Apply>
				<Apply function="lessThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<Apply function="+">
						<FieldRef field="msg.odr_lmt"/>
						<FieldRef field="msg.eb_buffer"/>
					</Apply>
				</Apply>
			</Apply>
		</DerivedField>

		<!-- 
			Update the AlertHistory state for the current account if EB1 detected
		-->
		<DerivedField name="EB1AlertHistoryUpdate" dataType="boolean" optype="categorical">
			<Apply function="if">
				<Apply function="equal">
					<FieldRef field="AlertType"/>
					<Constant dataType="string">EB1</Constant>
				</Apply>

				<Apply function="incrementBy">
					<FieldRef field="ClientAlertsToday.eb001sent"/>
					<Constant dataType="integer">1</Constant> 
				</Apply>
				<Constant dataType="boolean">false</Constant> 
			</Apply>
		</DerivedField>


		<!-- 
			Update the AlertHistory state for the current account if EB2 detected
		-->
		<DerivedField name="EB2AlertHistoryUpdate" dataType="boolean" optype="categorical">
			<Apply function="if">
				<Apply function="equal">
					<FieldRef field="AlertType"/>
					<Constant dataType="string">EB2</Constant>
				</Apply>

				<Apply function="incrementBy">
					<FieldRef field="ClientAlertsToday.eb002sent"/>
					<Constant dataType="integer">1</Constant> 
				</Apply>
				<Constant dataType="boolean">false</Constant> 
			</Apply>
		</DerivedField>


		<!-- 
			Update the AlertHistory state for the current account as appropriate
		-->
		<DerivedField name="EBAlertHistoryUpdate" dataType="boolean" optype="categorical">
			<Apply function="or">
				<FieldRef field="EB2AlertHistoryUpdate"/>
				<FieldRef field="EB1AlertHistoryUpdate"/>
			</Apply>
		</DerivedField>

		<!--
			For offline events, assess whether an offline event notification should be posted
		-->
		<DerivedField name="ShouldEBOfflineEventBeIssued" dataType="boolean" optype="categorical">
			<Apply function="if">
				<Apply function="and">
					<Apply function="equal">
						<FieldRef field="EBOfflineEvent"/>
						<Constant dataType="boolean">true</Constant>
					</Apply>
					<Apply function="equal">
						<FieldRef field="SumOfAlertsSeenToday"/>
						<Constant dataType="integer">0</Constant>
					</Apply>
				</Apply>

				<Apply function="Put">  <!-- Set OfflineEvent -->
					<Constant dataType="string">OfflineEvent</Constant>
					<Constant dataType="string">true</Constant> 
				</Apply>
				<Constant dataType="boolean">false</Constant>
			</Apply>
		</DerivedField>

		<!--
			Assess whether we need to send a Emer Borrow result.
		-->
		<DerivedField name="SendEBResult" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="equal">
					<FieldRef field="AcctHasEBLimit"/>
					<Constant dataType="boolean">true</Constant>
				</Apply>
				<Apply function="equal">
					<FieldRef field="InEmergencyBorrowRange"/>
					<Constant dataType="boolean">true</Constant>
				</Apply>
				<Apply function="equal">
					<FieldRef field="DebitHasCausedEBCondition"/>
					<Constant dataType="boolean">true</Constant>
				</Apply>
				<Apply function="or">
					<FieldRef field="ShouldEBOfflineEventBeIssued"/>
					<FieldRef field="ShouldOnlineEBEventBeIssued"/>
				</Apply>
			</Apply>
		</DerivedField>
		
		<!-- 
			When it is necessary to send an EB Alert, do thse actions (all return true
			if they complete normally)
		-->
		<DerivedField name="UpdateEBAlertAction" dataType="boolean" optype="categorical">
			<Apply function="and">
				<FieldRef field="EBAlertType"/> <!-- this sets AlertType either EB1 or EB2-->
				<FieldRef field="EBAlertHistoryUpdate"/>
				<FieldRef field="MaterializeOutputs"/>
			</Apply>
		</DerivedField>

		<!--
			Determine whether to send Emer Borrow result and put new count when true.
		-->		
		<DerivedField name="SendEBResultDetermination" dataType="boolean" optype="categorical">
			<Apply function="if">
				<FieldRef field="SendEBResult"/>

				<FieldRef field="UpdateEBAlertAction"/>
				<Apply function="and">
					<FieldRef field="MaterializeOutputs"/> <!-- Nevertheless make sure fields are materialized -->
					<Constant dataType="boolean">false</Constant>
				</Apply>
			</Apply>
		</DerivedField>


		<!--
			**********************************************************
			*  Near OD Alert Derivation 
			**********************************************************
		-->

		<!--
			Calculate the near overdraft limit:

			msg.ODR_LMT – (msg.ODR_LMT * ClientPrefs.NO_FACTOR/100)
		-->
		<DerivedField name="NearOverdraftLimit" dataType="double" optype="continuous">
			<Apply function="-">
				<FieldRef field="msg.odr_lmt"/>
				<Apply function="-">
					<FieldRef field="msg.odr_lmt"/>
					<Apply function="*">
						<FieldRef field="msg.odr_lmt"/>
						<Apply function="/">
							<FieldRef field="ClientPrefs.no_factor"/>
							<Constant dataType="double">100</Constant>
						</Apply>
					</Apply>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Is the auth run ledger balance in the near overdraft range?
		-->
		<DerivedField name="InNearOverdraftRange" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="lessThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="NearOverdraftLimit"/>
				</Apply>
				<Apply function="greaterThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<Apply function="+">
						<FieldRef field="msg.odr_lmt"/>
						<FieldRef field="msg.eb_buffer"/>
					</Apply>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Was it the debit entry has taken the balance into the Near Overdraft tier?
		-->
		<DerivedField name="DebitHasCausedNOCondition" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="greaterOrEqual">
					<FieldRef field="PreviousBalance"/>
					<FieldRef field="msg.run_ldg_xau"/>
				</Apply>
				<Apply function="lessThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="NearOverdraftLimit"/>
				</Apply>
			</Apply>
		</DerivedField>
		<!--
			Note if the event being considered occurred after hours
		-->
		<DerivedField name="NOOfflineEvent" dataType="boolean" optype="categorical">
			<Apply function="not">
				<Apply function="Between">
					<Apply function="CompressedTimeHHMMSSCC2Secs">
						<FieldRef field="msg.ent_tme"/>
					</Apply>
					<FieldRef field="NOAlertParms.online_start_time"/>
					<FieldRef field="NOAlertParms.online_end_time"/>
					<Constant dataType="boolean">true</Constant>
				</Apply>
			</Apply>
		</DerivedField>


		<!--
			For offline events, assess whether an offline event notification should be posted
		-->
		<DerivedField name="ShouldNOOfflineEventBeIssued" dataType="boolean" optype="categorical">
			<Apply function="if">
				<Apply function="and">
					<FieldRef field="NOOfflineEvent"/>
					<Apply function="equal">
						<FieldRef field="SumOfAlertsSeenToday"/>
						<Constant dataType="integer">0</Constant>
					</Apply>
				</Apply>

				<Apply function="Put">  <!-- Set OfflineEvent -->
					<Constant dataType="string">OfflineEvent</Constant>
					<Constant dataType="string">true</Constant> 
				</Apply>
				<Constant dataType="boolean">false</Constant>
			</Apply>
		</DerivedField>

		<!--
			Assess whether an online Over Draft 3 event notification is to be issued
		-->
		<DerivedField name="ShouldOnlineNOEventBeIssued" dataType="boolean" optype="categorical">
			<Apply function="not">
				<Apply function="or">
					<Apply function="greaterThan">
						<Apply function="+">
							<FieldRef field="ClientAlertsToday.utfsent"/>
							<FieldRef field="ClientAlertsToday.ptfsent"/>
							<FieldRef field="ClientAlertsToday.eb001sent"/>
							<FieldRef field="ClientAlertsToday.eb002sent"/>
						</Apply>
						<Constant dataType="integer">0</Constant>
					</Apply>
					<Apply function="greaterOrEqual">
						<FieldRef field="ClientAlertsToday.no001sent"/>
						<FieldRef field="ODAlertParms.max_alerts_per_day"/>
					</Apply>
				</Apply>
			</Apply>
		</DerivedField>


		<!--
			Assess whether we need to send a Near Overdraft result.
		-->
		<DerivedField name="SendNOResult" dataType="string" optype="categorical">
			<Apply function="if">
				<Apply function="and">
					<FieldRef field="InNearOverdraftRange"/>
					<FieldRef field="DebitHasCausedNOCondition"/>
					<Apply function="or">
						<FieldRef field="ShouldNOOfflineEventBeIssued"/>
						<FieldRef field="ShouldOnlineNOEventBeIssued"/>
					</Apply>
				</Apply>
				<Constant dataType="string">NO1</Constant> 
				<Constant dataType="string">NOTSET</Constant>       
			</Apply>
		</DerivedField>

		<!-- 
			When it is necessary to send an OD3 Alert, do thse actions (all return true
			if they complete normally)
		-->
		<DerivedField name="UpdateNOAlertAction" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="Put">  <!-- Set AlertType -->
					<Constant dataType="string">AlertType</Constant>
					<Constant dataType="string">NO1</Constant> 
				</Apply>
				<Apply function="incrementBy">
					<FieldRef field="ClientAlertsToday.no001sent"/>
					<Constant dataType="integer">1</Constant> 
				</Apply>

				<FieldRef field="AlertHistoryUpdate"/>
				<FieldRef field="MaterializeOutputs"/>
			</Apply>
		</DerivedField>

		<!--
			Determine whether to send Overdraft 3 result and put new count when true.
		-->		
		<DerivedField name="SendNOResultDetermination" dataType="boolean" optype="categorical">
			<Apply function="if">
				<Apply function="equal">
					<FieldRef field="SendNOResult"/>
					<Constant dataType="string">NO1</Constant>
				</Apply>

				<FieldRef field="UpdateNOAlertAction"/>
				<Apply function="and">
					<FieldRef field="MaterializeOutputs"/> <!-- Nevertheless make sure fields are materialized -->
					<Constant dataType="boolean">false</Constant>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			**********************************************************
			*  OD Alert Derivation 
			**********************************************************
		-->

		<!--
			Does this client subscribe to the emergency borrowing account feature
		-->
		<DerivedField name="AcctHasODLimit" dataType="boolean" optype="categorical">
			<Apply function="greaterThan">
				<FieldRef field="msg.odr_lmt"/>
				<Constant dataType="double">0</Constant>
			</Apply>
		</DerivedField>

		<!--
			Is the auth run ledger balance in the overdraft range?
		-->
		<DerivedField name="InOD3Range" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="lessThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="ClientTierLimits.t2_end_amt"/>
				</Apply>
				<Apply function="greaterThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<Apply function="+">
						<FieldRef field="msg.odr_lmt"/>
						<FieldRef field="msg.eb_buffer"/>
					</Apply>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Was it the debit entry has taken the balance into the 3rd Overdraft tier?
		-->
		<DerivedField name="DebitHasCausedOD3Condition" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="greaterOrEqual">
					<FieldRef field="PreviousBalance"/>
					<FieldRef field="ClientTierLimits.t2_end_amt"/>
				</Apply>
				<Apply function="lessThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="ClientTierLimits.t2_end_amt"/>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Is the auth run ledger balance in the overdraft range?
		-->
		<DerivedField name="InOD2Range" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="greaterOrEqual">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="ClientTierLimits.t2_end_amt"/>
				</Apply>
				<Apply function="lessThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="ClientTierLimits.t1_end_amt"/>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Was it the debit entry has taken the balance into the 2nd Overdraft tier?
		-->
		<DerivedField name="DebitHasCausedOD2Condition" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="greaterOrEqual">
					<FieldRef field="PreviousBalance"/>
					<FieldRef field="ClientTierLimits.t1_end_amt"/>
				</Apply>
				<Apply function="lessThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="ClientTierLimits.t1_end_amt"/>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Is the auth run ledger balance in the overdraft range?
		-->
		<DerivedField name="InOD1Range" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="greaterOrEqual">
					<FieldRef field="msg.run_ldg_xau"/>
					<Apply function="+">
						<FieldRef field="msg.odr_lmt"/>
						<FieldRef field="msg.eb_buffer"/>
					</Apply>
				</Apply>
				<Apply function="greaterOrEqual">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="ClientTierLimits.t1_end_amt"/>
				</Apply>
				<Apply function="lessThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="msg.od_buffer"/>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Was it the debit entry has taken the balance into the 1st Overdraft tier?
		-->
		<DerivedField name="DebitHasCausedOD1Condition" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="greaterOrEqual">
					<FieldRef field="PreviousBalance"/>
					<FieldRef field="msg.od_buffer"/>
				</Apply>
				<Apply function="lessThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="msg.od_buffer"/>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Note if the event being considered occurred after hours
		-->
		<DerivedField name="ODOfflineEvent" dataType="boolean" optype="categorical">
			<Apply function="if">
				<Apply function="not">
					<Apply function="Between">
						<Apply function="CompressedTimeHHMMSSCC2Secs">
							<FieldRef field="msg.ent_tme"/>
						</Apply>
						<FieldRef field="ODAlertParms.online_start_time"/>
						<FieldRef field="ODAlertParms.online_end_time"/>
						<Constant dataType="boolean">true</Constant>
					</Apply>
				</Apply>
				<Apply function="Put">  <!-- Set OfflineEvent -->
					<Constant dataType="string">OfflineEvent</Constant>
					<Constant dataType="string">true</Constant> 
				</Apply>
				<Constant dataType="boolean">false</Constant>
			</Apply>
		</DerivedField>

		<!--
			For offline events, assess whether an offline event notification should be posted
		-->
		<DerivedField name="ShouldODOfflineEventBeIssued" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="equal">
					<FieldRef field="ODOfflineEvent"/>
					<Constant dataType="boolean">true</Constant>
				</Apply>
				<Apply function="equal">
					<FieldRef field="SumOfAlertsSeenToday"/>
					<Constant dataType="integer">0</Constant>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Assess whether an online Over Draft 3 event notification is to be issued
		-->
		<DerivedField name="ShouldOnlineOD3EventBeIssued" dataType="boolean" optype="categorical">
			<Apply function="not">
				<Apply function="or">
					<Apply function="greaterThan">
						<Apply function="+">
							<FieldRef field="ClientAlertsToday.utfsent"/>
							<FieldRef field="ClientAlertsToday.ptfsent"/>
							<FieldRef field="ClientAlertsToday.eb001sent"/>
							<FieldRef field="ClientAlertsToday.eb002sent"/>
							<FieldRef field="ClientAlertsToday.no001sent"/>
						</Apply>
						<Constant dataType="integer">0</Constant>
					</Apply>
					<Apply function="greaterOrEqual">
						<FieldRef field="ClientAlertsToday.od003sent"/>
						<FieldRef field="ODAlertParms.max_alerts_per_day"/>
					</Apply>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Assess whether an online Over Draft 3 event notification is to be issued
		-->
		<DerivedField name="ShouldOnlineOD2EventBeIssued" dataType="boolean" optype="categorical">
			<Apply function="not">
				<Apply function="or">
					<Apply function="greaterThan">
						<Apply function="+">
							<FieldRef field="ClientAlertsToday.utfsent"/>
							<FieldRef field="ClientAlertsToday.ptfsent"/>
							<FieldRef field="ClientAlertsToday.eb001sent"/>
							<FieldRef field="ClientAlertsToday.eb002sent"/>
							<FieldRef field="ClientAlertsToday.no001sent"/>
							<FieldRef field="ClientAlertsToday.od003sent"/>
						</Apply>
						<Constant dataType="integer">0</Constant>
					</Apply>
					<Apply function="greaterOrEqual">
						<FieldRef field="ClientAlertsToday.od002sent"/>
						<FieldRef field="ODAlertParms.max_alerts_per_day"/>
					</Apply>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Assess whether an online Over Draft 3 event notification is to be issued
		-->
		<DerivedField name="ShouldOnlineOD1EventBeIssued" dataType="boolean" optype="categorical">
			<Apply function="not">
				<Apply function="or">
					<Apply function="greaterThan">
						<Apply function="+">
							<FieldRef field="ClientAlertsToday.utfsent"/>
							<FieldRef field="ClientAlertsToday.ptfsent"/>
							<FieldRef field="ClientAlertsToday.eb001sent"/>
							<FieldRef field="ClientAlertsToday.eb002sent"/>
							<FieldRef field="ClientAlertsToday.no001sent"/>
							<FieldRef field="ClientAlertsToday.od003sent"/>
							<FieldRef field="ClientAlertsToday.od002sent"/>
						</Apply>
						<Constant dataType="integer">0</Constant>
					</Apply>
					<Apply function="greaterOrEqual">
						<FieldRef field="ClientAlertsToday.od001sent"/>
						<FieldRef field="ODAlertParms.max_alerts_per_day"/>
					</Apply>
				</Apply>
			</Apply>
		</DerivedField>


		<!--
			Assess whether we need to send a Near Overdraft result.
		-->
		<DerivedField name="SendOD3Result" dataType="string" optype="categorical">
			<Apply function="if">
				<Apply function="and">
					<FieldRef field="InOD3Range"/>
					<FieldRef field="DebitHasCausedOD3Condition"/>
					<Apply function="or">
						<FieldRef field="ShouldODOfflineEventBeIssued"/>
						<FieldRef field="ShouldOnlineOD3EventBeIssued"/>
					</Apply>
				</Apply>
				<Constant dataType="string">OD3</Constant> 
				<Constant dataType="string">NOTSET</Constant>       
			</Apply>
		</DerivedField>
		
		<!--
			Assess whether we need to send a Near Overdraft result.
		-->
		<DerivedField name="SendOD2Result" dataType="string" optype="categorical">
			<Apply function="if">
				<Apply function="and">
					<FieldRef field="InOD2Range"/>
					<FieldRef field="DebitHasCausedOD2Condition"/>
					<Apply function="or">
						<FieldRef field="ShouldODOfflineEventBeIssued"/>
						<FieldRef field="ShouldOnlineOD2EventBeIssued"/>
					</Apply>
				</Apply>
				<Constant dataType="string">OD2</Constant> 
				<Constant dataType="string">NOTSET</Constant>       
			</Apply>
		</DerivedField>
		
		<!--
			Assess whether we need to send a Near Overdraft result.
		-->
		<DerivedField name="SendOD1Result" dataType="string" optype="categorical">
			<Apply function="if">
				<Apply function="and">
					<FieldRef field="InOD1Range"/>
					<FieldRef field="DebitHasCausedOD1Condition"/>
					<Apply function="or">
						<FieldRef field="ShouldODOfflineEventBeIssued"/>
						<FieldRef field="ShouldOnlineOD1EventBeIssued"/>
					</Apply>
				</Apply>
				<Constant dataType="string">OD1</Constant> 
				<Constant dataType="string">NOTSET</Constant>       
			</Apply>
		</DerivedField>
		
		<!-- 
			When it is necessary to send an OD3 Alert, do thse actions (all return true
			if they complete normally)
		-->
		<DerivedField name="UpdateOD3AlertAction" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="Put">  <!-- Set AlertType -->
					<Constant dataType="string">AlertType</Constant>
					<Constant dataType="string">OD3</Constant> 
				</Apply>
				<Apply function="incrementBy">
					<FieldRef field="ClientAlertsToday.od003sent"/>
					<Constant dataType="integer">1</Constant> 
				</Apply>
				<FieldRef field="AlertHistoryUpdate"/>
				<FieldRef field="MaterializeOutputs"/>
			</Apply>
		</DerivedField>

		<!--
			Determine whether to send Overdraft 3 result and put new count when true.
		-->		
		<DerivedField name="SendOD3ResultDetermination" dataType="boolean" optype="categorical">
			<Apply function="if">
				<Apply function="equal">
					<FieldRef field="SendOD3Result"/>
					<Constant dataType="string">OD3</Constant>
				</Apply>

				<FieldRef field="UpdateOD3AlertAction"/>
				<Apply function="and">
					<FieldRef field="MaterializeOutputs"/> <!-- Nevertheless make sure fields are materialized -->
					<Constant dataType="boolean">false</Constant>
				</Apply>
			</Apply>
		</DerivedField>

		<!-- 
			When it is necessary to send an OD2 Alert, do thse actions (all return true
			if they complete normally)
		-->
		<DerivedField name="UpdateOD2AlertAction" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="Put">  <!-- Set AlertType -->
					<Constant dataType="string">AlertType</Constant>
					<Constant dataType="string">OD2</Constant> 
				</Apply>
				<Apply function="incrementBy">
					<FieldRef field="ClientAlertsToday.od002sent"/>
					<Constant dataType="integer">1</Constant> 
				</Apply>
				<FieldRef field="AlertHistoryUpdate"/>
				<FieldRef field="MaterializeOutputs"/>
			</Apply>
		</DerivedField>

		<!--
			Determine whether to send Overdraft 2 result and put new count when true.
		-->		
		<DerivedField name="SendOD2ResultDetermination" dataType="boolean" optype="categorical">
			<Apply function="if">
				<Apply function="equal">
					<FieldRef field="SendOD2Result"/>
					<Constant dataType="string">OD2</Constant>
				</Apply>

				<FieldRef field="UpdateOD2AlertAction"/>
				<Apply function="and">
					<FieldRef field="MaterializeOutputs"/> <!-- Nevertheless make sure fields are materialized -->
					<Constant dataType="boolean">false</Constant>
				</Apply>
			</Apply>
		</DerivedField>

		<!-- 
			When it is necessary to send an OD1 Alert, do thse actions (all return true
			if they complete normally)
		-->
		<DerivedField name="UpdateOD1AlertAction" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="Put">  <!-- Set AlertType -->
					<Constant dataType="string">AlertType</Constant>
					<Constant dataType="string">OD1</Constant> 
				</Apply>
				<Apply function="incrementBy">
					<FieldRef field="ClientAlertsToday.od001sent"/>
					<Constant dataType="integer">1</Constant> 
				</Apply>
				<FieldRef field="AlertHistoryUpdate"/>
				<FieldRef field="MaterializeOutputs"/>
			</Apply>
		</DerivedField>

		<!--
			Determine whether to send Overdraft 1 result and put new count when true.
		-->		
		<DerivedField name="SendOD1ResultDetermination" dataType="boolean" optype="categorical">
			<Apply function="if">
				<Apply function="equal">
					<FieldRef field="SendOD1Result"/>
					<Constant dataType="string">OD1</Constant>
				</Apply>

				<FieldRef field="UpdateOD1AlertAction"/>
				<Apply function="and">
					<FieldRef field="MaterializeOutputs"/> <!-- Nevertheless make sure fields are materialized -->
					<Constant dataType="boolean">false</Constant>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			**********************************************************
			*  LB Alert Derivation 
			**********************************************************
		-->

		<!--
			Does this client subscribe to the emergency borrowing account feature
		-->
		<DerivedField name="AcctHasLBLimit" dataType="boolean" optype="categorical">
			<Apply function="greaterThan">
				<FieldRef field="ClientPrefs.lb_limit"/>
				<Constant dataType="double">0</Constant>
			</Apply>
		</DerivedField>

		<!--
			Is the auth run ledger balance in the low balance range?  
		-->
		<DerivedField name="InLowBalanceRange" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="lessThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="msg.lb_limit"/>
				</Apply>
				<Apply function="greaterOrEqual">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="msg.od_buffer"/>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Is the auth run ledger balance in the low balance range?  
		-->
		<DerivedField name="DebitHasCausedLBCondition" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="greaterOrEqual">
					<FieldRef field="PreviousBalance"/>
					<FieldRef field="msg.lb_limit"/>
				</Apply>
				<Apply function="lessThan">
					<FieldRef field="msg.run_ldg_xau"/>
					<FieldRef field="msg.lb_limit"/>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Note if the event being considered occurred after hours
		-->
		<DerivedField name="LBOfflineEvent" dataType="boolean" optype="categorical">
			<Apply function="if">
				<Apply function="not">
					<Apply function="Between">
						<Apply function="CompressedTimeHHMMSSCC2Secs">
							<FieldRef field="msg.ent_tme"/>
						</Apply>
						<FieldRef field="LBAlertParms.online_start_time"/>
						<FieldRef field="LBAlertParms.online_end_time"/>
						<Constant dataType="boolean">true</Constant>
					</Apply>
				</Apply>
				<Apply function="Put">  <!-- Set OfflineEvent -->
					<Constant dataType="string">OfflineEvent</Constant>
					<Constant dataType="string">true</Constant> 
				</Apply>
				<Constant dataType="boolean">false</Constant>
			</Apply>
		</DerivedField>

		<!--
			For offline events, assess whether an offline event notification should be posted
		-->
		<DerivedField name="ShouldLBOfflineEventBeIssued" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="equal">
					<FieldRef field="LBOfflineEvent"/>
					<Constant dataType="boolean">true</Constant>
				</Apply>
				<Apply function="equal">
					<FieldRef field="SumOfAlertsSeenToday"/>
					<Constant dataType="integer">0</Constant>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Assess whether an online Low Bal event notification is to be issued
		-->
		<DerivedField name="ShouldOnlineLBEventBeIssued" dataType="boolean" optype="categorical">
			<Apply function="not">
				<Apply function="or">
					<Apply function="greaterOrEqual">
						<Apply function="+">
							<FieldRef field="ClientAlertsToday.eb001sent"/>
							<FieldRef field="ClientAlertsToday.eb002sent"/>
							<FieldRef field="ClientAlertsToday.no001sent"/>
							<FieldRef field="ClientAlertsToday.od001sent"/>
							<FieldRef field="ClientAlertsToday.od002sent"/>
							<FieldRef field="ClientAlertsToday.od003sent"/>
							<FieldRef field="ClientAlertsToday.lb001sent"/>
						</Apply>
						<FieldRef field="LBAlertParms.max_alerts_per_day"/>
					</Apply>
					<Apply function="greaterOrEqual">
						<Apply function="+">
							<FieldRef field="ClientAlertsToday.utfsent"/>
							<FieldRef field="ClientAlertsToday.ptfsent"/>
						</Apply>
						<Constant dataType="integer">0</Constant>
					</Apply>
				</Apply>
			</Apply>
		</DerivedField>

		<!--
			Assess whether we need to send a Low Balance result.
		-->
		<DerivedField name="SendLBResult" dataType="string" optype="categorical">
			<Apply function="if">
				<Apply function="and">
					<Apply function="equal">
						<FieldRef field="AcctHasLBLimit"/>
						<Constant dataType="boolean">true</Constant>
					</Apply>
					<Apply function="equal">
						<FieldRef field="InLowBalanceRange"/>
						<Constant dataType="boolean">true</Constant>
					</Apply>
					<Apply function="equal">
						<FieldRef field="DebitHasCausedLBCondition"/>
						<Constant dataType="boolean">true</Constant>
					</Apply>
					<Apply function="or">
						<Apply function="equal">
							<FieldRef field="ShouldLBOfflineEventBeIssued"/>
							<Constant dataType="boolean">true</Constant>
						</Apply>
						<Apply function="equal">
							<FieldRef field="ShouldOnlineLBEventBeIssued"/>
							<Constant dataType="boolean">true</Constant>
						</Apply>
					</Apply>
				</Apply>
				<Constant dataType="string">LB1</Constant> 
				<Constant dataType="string">NOTSET</Constant>       
			</Apply>
		</DerivedField>
		


		<!-- 
			When it is necessary to send an EB Alert, do thse actions (all return true
			if they complete normally)
		-->
		<DerivedField name="UpdateLBAlertAction" dataType="boolean" optype="categorical">
			<Apply function="and">
				<Apply function="Put">  <!-- Set AlertType -->
					<Constant dataType="string">AlertType</Constant>
					<Constant dataType="string">LB1</Constant> 
				</Apply>
				<Apply function="incrementBy">
					<FieldRef field="ClientAlertsToday.lb001sent"/>
					<Constant dataType="integer">1</Constant> 
				</Apply>
				<FieldRef field="AlertHistoryUpdate"/>
				<FieldRef field="MaterializeOutputs"/>
			</Apply>
		</DerivedField>

		<!--
			Determine whether to send Low Bal result and put new count when true.
			Note: put will return true if it succeeds
		-->		
		<DerivedField name="SendLBResultDetermination" dataType="boolean" optype="categorical">
			<Apply function="if">
				<Apply function="equal">
					<FieldRef field="SendLBResult"/>
					<Constant dataType="string">LB1</Constant>
				</Apply>

				<FieldRef field="UpdateLBAlertAction"/>
				<Apply function="and">
					<FieldRef field="MaterializeOutputs"/> <!-- Nevertheless make sure fields are materialized -->
					<Constant dataType="boolean">false</Constant>
				</Apply>
			</Apply>
		</DerivedField>

	</TransformationDictionary>

	<RuleSetModel modelName="AlchemyRules" functionName="classification" algorithmName="RuleSet">
	    <MiningSchema>

			<MiningField name="SendResult" usageType="predicted"/>
			<MiningField name="OfflineEvent" usageType="supplementary"/>
			<MiningField name="AlertType" usageType="supplementary"/>
			<MiningField name="RUN_LDG_XAU" usageType="supplementary"/>
			<MiningField name="ACCT_SHORT_NM" usageType="supplementary"/>
			<MiningField name="ENT_DTE" usageType="supplementary"/>
			<MiningField name="MOBILE_NUMBER" usageType="supplementary"/>

	    </MiningSchema>
	
		<RuleSet defaultScore="0">  
			<RuleSelectionMethod criterion="firstHit"/>
			<SimpleRule id="EBRule" score="6">
				<SimplePredicate field="SendEBResultDetermination" operator="equal" value="true"/>
			</SimpleRule>
			<SimpleRule id="NORule" score="5">
				<SimplePredicate field="SendNOResultDetermination" operator="equal" value="true"/>
			</SimpleRule>
			<SimpleRule id="ODRule3" score="4">
				<SimplePredicate field="SendOD3ResultDetermination" operator="equal" value="true"/>
			</SimpleRule>
			<SimpleRule id="ODRule2" score="3">
				<SimplePredicate field="SendOD2ResultDetermination" operator="equal" value="true"/>
			</SimpleRule>
			<SimpleRule id="ODRule1" score="2">
				<SimplePredicate field="SendOD1ResultDetermination" operator="equal" value="true"/>
			</SimpleRule>
			<SimpleRule id="LBRule" score="1">
				<SimplePredicate field="SendLBResultDetermination" operator="equal" value="true"/>
			</SimpleRule>
	    </RuleSet> 
	</RuleSetModel>
</PMML>
